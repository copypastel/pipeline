<script>
  
  <% unless @video.nil? %>
  document.title = "Pipeline :: " + "<%= @video.title %>";

  function onYouTubePlayerReady(){
    var video = document.getElementById("video_player");
    video.loadVideoById("<%= @video.video_id %>", 0);
    video.playVideo();
    vid = "<%= @video.id %>";
    video.addEventListener("onStateChange", "pickNext");
  }
  
  function loadNextVideo(current_video_id){
    $.get("<%= url(:controller => 'videos', :action => 'next')%>", { id: current_video_id }, function(response){
      if(response.result == "false")
        setTimeout("loadNextVideo(" + current_video_id +")", 30000);
      else{
        alert("Current video id: " + current_video_id );
        var video = document.getElementById("video_player");
        video.loadVideoById(response.video_id, 0);
        video.playVideo();
        vid = response.id;
      };
    }, 'json');
  }
  
  function pickNext(state){
    if(state == 0)
      loadNextVideo(vid);
  }
  
  <% end %>
  
</script>