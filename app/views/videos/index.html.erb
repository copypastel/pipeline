<script>
  
  <% unless @video.nil? %>
  document.title = "Pipeline :: " + "<%= @video.title %>";

  function onYouTubePlayerReady(){
    var video = document.getElementById("video_player");
    video.loadVideoById("<%= @video.video_id %>", 0);
    video.playVideo();
    vid = "<%= @video.id %>";
    video.addEventListener("onStateChange", "YoutubeStateCallback");
  }
  
  function loadNextVideo(current_video_id){
    $.get("<%= url(:controller => 'videos', :action => 'next')%>", { id: current_video_id }, function(response){
      if(response.result == "false")
        setTimeout("loadNextVideo(" + current_video_id +")", 30000);
      else{
        var video = document.getElementById("video_player");
        video.loadVideoById(response.video_id, 0);
        video.playVideo();
//        vid = response.id;
        document.title = "Pipeline :: " + response.title;
      };
    }, 'json');
  }
  
// Set by an event to be the callback, contains the proper response
  function YoutubeStateCallback(state){
    if(state == YOUTUBE_CMD_VIDEO_DONE) {
      loadNextVideo(vid);
	}
  }
  
  <% end %>
  
</script>